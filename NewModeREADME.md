Τεχνική Ανάλυση: Λειτουργία Διαχωρισμού Ενιαίας Λήψης (Single-Shot Splitting Mode)
==================================================================================

1\. Επισκόπηση
--------------

Αυτό το έγγραφο περιγράφει την ανάλυση και τον σχεδιασμό μιας νέας, βασικής λειτουργίας στην εφαρμογή DigiPage Scanner. Η λειτουργία αυτή, με την ονομασία "Single-Shot Splitting Mode", προστίθεται για την υποστήριξη ενός νέου τύπου scanner βιβλίων, ο οποίος καταγράφει ένα ολόκληρο άνοιγμα βιβλίου (δύο σελίδες) σε μία ενιαία, πλατιά εικόνα.

Στόχος είναι η παροχή ενός γρήγορου, ημι-αυτοματοποιημένου και μη-καταστροφικού περιβάλλοντος εργασίας, όπου ο χρήστης μπορεί να "διαχωρίσει" ψηφιακά την αρχική εικόνα στις δύο τελικές σελίδες που την αποτελούν, παίζοντας κυρίως εποπτικό ρόλο.

2\. Εμπειρία Χρήστη (UX) & Ροή Εργασίας
---------------------------------------

Η βασική φιλοσοφία της λειτουργίας είναι η **"Εποπτεία αντί για Ενέργεια"**. Η εφαρμογή εκτελεί προληπτικά τις περισσότερες ενέργειες και ο χρήστης παρεμβαίνει μόνο όταν απαιτείται διόρθωση.

1.  **Επιλογή Λειτουργίας:** Ο χρήστης επιλέγει τον τύπο του scanner του ("Scanner Ενιαίας Λήψης") από τις ρυθμίσεις της εφαρμογής. Αυτή η επιλογή αποθηκεύεται και διαμορφώνει το περιβάλλον εργασίας κάθε φορά που ξεκινά η εφαρμογή.
    
2.  **Περιβάλλον Εργασίας:** Το κεντρικό τμήμα της εφαρμογής μετατρέπεται σε έναν μεγάλο, ενιαίο ImageViewer. Το sidebar και το bottom bar παραμένουν σταθερά, προσφέροντας μια οικεία εμπειρία, αλλά τα στοιχεία ελέγχου τους προσαρμόζονται (π.χ., το κουμπί αποθήκευσης γίνεται "Ενημέρωση", ενώ άσχετες λειτουργίες όπως η περιστροφή αποκρύπτονται).
    
3.  **Άφιξη Νέας Σάρωσης:**
    
    *   Μια νέα εικόνα (scan\_N.jpg) ανιχνεύεται στον φάκελο σάρωσης.
        
    *   **Αυτόματα**, η εφαρμογή ανακτά τις ρυθμίσεις πλαισίων από την αμέσως προηγούμενη εικόνα (scan\_N-1.jpg).
        
    *   **Αυτόματα**, εκτελεί την επεξεργασία: κόβει τις δύο σελίδες και τις αποθηκεύει στον υποφάκελο final/. Η αρχική εικόνα παραμένει ανέπαφη.
        
    *   **Αυτόματα**, η νέα εικόνα scan\_N.jpg εμφανίζεται στον viewer, με τα πλαίσια που χρησιμοποιήθηκαν ήδη σχεδιασμένα πάνω της.
        
4.  **Οπτική Σαφήνεια:** Για να διευκολύνεται η εστίαση, ο ImageViewer παρουσιάζει την περιοχή της εικόνας που βρίσκεται **εκτός** των πλαισίων επιλογής ελαφρώς σκοτεινή, ενώ η περιοχή **εντός** των πλαισίων παραμένει πλήρως φωτεινή. Το αριστερό πλαίσιο επιλογής έχει πράσινο περίγραμμα και το δεξί κόκκινο, για άμεση διάκριση.
    
5.  **Ρόλος του Χρήστη:** Ο χρήστης βλέπει την ήδη επεξεργασμένη εικόνα.
    
    *   **Σενάριο 95%:** Τα πλαίσια είναι σωστά. Ο χρήστης δεν κάνει απολύτως τίποτα και περιμένει την επόμενη σάρωση.
        
    *   **Σενάριο 5%:** Το βιβλίο μετακινήθηκε. Ο χρήστης προσαρμόζει τα πλαίσια και πατάει το κουμπί **"Ενημέρωση"**. Αυτή η ενέργεια ενημερώνει τις αποθηκευμένες συντεταγμένες για τη συγκεκριμένη εικόνα και αντικαθιστά τις αντίστοιχες εικόνες στον φάκελο final/.
        
6.  **Αδιάκοπη Ροή:** Αν μια νέα σάρωση φτάσει ενώ ο χρήστης επεξεργάζεται μια προηγούμενη εικόνα, η εφαρμογή δεν τον διακόπτει. Η νέα εικόνα εμφανίζεται αυτόματα μόνο αν ο χρήστης δεν έχει ξεκινήσει κάποια προσαρμογή.
    

3\. Τεχνική Προσέγγιση (Υψηλού Επιπέδου)
----------------------------------------

*   **Διαχείριση Λειτουργίας:** Μια νέα ρύθμιση στο αρχείο config.json καθορίζει ποιο περιβάλλον εργασίας θα φορτωθεί κατά την εκκίνηση, εξασφαλίζοντας ότι ο χρήστης βλέπει πάντα το σωστό UI για τον εξοπλισμό του.
    
*   **Μη-Καταστροφική Επεξεργασία:** Όλες οι τελικές, "κομμένες" εικόνες αποθηκεύονται σε έναν υποφάκελο final/. Τα αρχικά αρχεία σάρωσης δεν τροποποιούνται ποτέ, επιτρέποντας στον χρήστη να ανατρέξει και να διορθώσει τα πλαίσια ανά πάσα στιγμή.
    
*   **Επιμονή Δεδομένων (Data Persistence):** Οι συντεταγμένες των πλαισίων για κάθε αρχική εικόνα αποθηκεύονται σε ένα αρχείο μεταδεδομένων (π.χ., layout\_data.json) εντός του φακέλου σάρωσης. Αυτό επιτρέπει στην εφαρμογή να "θυμάται" τις ρυθμίσεις για κάθε εικόνα ξεχωριστά.
    
*   **Αρχιτεκτονική UI:** Το κύριο παράθυρο της εφαρμογής θα χρησιμοποιεί μια δυναμική προσέγγιση για την εναλλαγή του κεντρικού του τμήματος μεταξύ της διάταξης διπλής προβολής και της νέας διάταξης ενιαίας προβολής, διατηρώντας τα περιφερειακά στοιχεία (sidebar, bottom bar) κοινά.
    

4\. Προτάσεις & Ενδεικτικές Υλοποιήσεις
---------------------------------------

### 4.1. Διαχείριση Λειτουργίας (Mode Management)

*   **config.py**: Προσθήκη του κλειδιού "scanner\_mode": "dual\_scan" στο DEFAULT\_CONFIG. Οι πιθανές τιμές είναι "dual\_scan" και "single\_split".
    
*   **settings\_dialog.py**: Χρήση QRadioButton για την επιλογή του mode. Η επιλογή αποθηκεύεται στο config.json κατά την αποθήκευση των ρυθμίσεων.
    
*   **main\_window.py**: Στην \_\_init\_\_, το πρόγραμμα διαβάζει το scanner\_mode. Ένα QStackedWidget χρησιμοποιείται ως κεντρικό widget. Δύο μέθοδοι, π.χ. \_setup\_dual\_scan\_ui() και \_setup\_single\_split\_ui(), δημιουργούν τα αντίστοιχα layouts, τα οποία προστίθενται στο QStackedWidget. Το setCurrentIndex καλείται για να εμφανιστεί το σωστό UI.
    

### 4.2. Επιμονή Δεδομένων & Επεξεργασία

*   **main\_window.py**: Υλοποίηση βοηθητικών μεθόδων \_load\_layout\_data() και \_save\_layout\_data() που θα διαχειρίζονται την ανάγνωση και εγγραφή στο αρχείο layout\_data.json χρησιμοποιώντας το module json της Python. Το μονοπάτι του αρχείου θα είναι os.path.join(self.scan\_folder, 'layout\_data.json').
    
*   **workers.py**: Δημιουργία ενός νέου @Slot, π.χ. perform\_page\_split(self, source\_path, rects\_data), όπου το rects\_data θα είναι ένα dictionary με τις συντεταγμένες. Η μέθοδος θα χρησιμοποιεί τη βιβλιοθήκη Pillow για τις λειτουργίες Image.open() και img.crop(). Η δημιουργία του φακέλου final/ μπορεί να γίνει με os.makedirs(..., exist\_ok=True).
    

### 4.3. ImageViewer για το Splitting Mode

*   **image\_viewer.py**:
    
    *   Προσθήκη μιας νέας κατάστασης, π.χ. InteractionMode.PAGE\_SPLITTING.
        
    *   Η κλάση θα διαχειρίζεται δύο ορθογώνια (self.left\_rect, self.right\_rect).
        
    *   Η μέθοδος paintEvent θα ανανεωθεί:
        
        1.  Σχεδιάζει ολόκληρη την εικόνα.
            
        2.  Χρησιμοποιεί QPainterPath για να δημιουργήσει μια μάσκα που καλύπτει τα πάντα **εκτός** από τα δύο ορθογώνια.
            
        3.  Γεμίζει αυτή τη μάσκα με ένα ημιδιαφανές μαύρο χρώμα (QColor(0, 0, 0, 100)) για να δημιουργήσει το εφέ της σκίασης.
            
        4.  Σχεδιάζει τα περιγράμματα των ορθογωνίων με τα κατάλληλα χρώματα (QPen).
            
    *   Οι μέθοδοι διαχείρισης του ποντικιού (mousePressEvent, mouseMoveEvent κτλ.) θα επεκταθούν για να ανιχνεύουν με ποιο από τα δύο πλαίσια (ή τις λαβές τους) αλληλεπιδρά ο χρήστης.
        
    *   Ένα σήμα crop\_adjustment\_started θα εκπέμπεται κατά την έναρξη της αλληλεπίδρασης για να ενημερώνεται η MainWindow.